rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if user is admin
    function isAdmin() {
      return request.auth != null && 
        request.auth.token.admin == true;
    }
    
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper function to check if user can access their own data
    function isOwner(userId) {
      return request.auth != null && 
        request.auth.uid == userId;
    }
    
    // ===========================================
    // SUGGESTIONS COLLECTION
    // ===========================================
    
    // Suggestions - authenticated users can read/create, admins can modify
    match /suggestions/{suggestionId} {
      // Anyone authenticated can read suggestions
      allow read: if isAuthenticated();
      
      // Anyone authenticated can create suggestions
      allow create: if isAuthenticated() && 
        // Ensure submittedBy.userId matches the authenticated user
        (request.resource.data.submittedBy.userId == request.auth.uid ||
         resource.data.submittedBy.source == 'automated');
      
      // Only admins can update suggestions (for review process)
      allow update: if isAdmin();
      
      // Only admins can delete suggestions
      allow delete: if isAdmin();
    }
    
    // ===========================================
    // CHANGE HISTORY COLLECTION
    // ===========================================
    
    // Change history - read only for authenticated users, only functions can write
    match /change-history/{historyId} {
      allow read: if isAuthenticated();
      allow create: if false; // Only Cloud Functions can create
      allow update, delete: if false; // Immutable audit log
    }
    
    // ===========================================
    // TRANSFORMATION JOBS COLLECTION
    // ===========================================
    
    // Transformation jobs - admin only
    match /transformation-jobs/{jobId} {
      allow read, write: if isAdmin();
    }
    
    // ===========================================
    // USER PROFILES COLLECTION
    // ===========================================
    
    // User profiles - users can read/write their own, admins can read all
    match /user-profiles/{userId} {
      allow read, write: if isOwner(userId);
      allow read: if isAdmin();
      allow write: if false; // Users manage their own profiles only
    }
    
    // ===========================================
    // ADMIN METADATA COLLECTIONS
    // ===========================================
    
    // Rate limiting collection - functions only
    match /rate-limits/{document} {
      allow read, write: if false; // Only Cloud Functions
    }
    
    // API usage tracking - admin read, functions write
    match /api-usage/{document} {
      allow read: if isAdmin();
      allow write: if false; // Only Cloud Functions
    }
    
    // Admin configuration - admin only
    match /admin-config/{document} {
      allow read, write: if isAdmin();
    }
    
    // Review queue - admin only
    match /review-queue/{document} {
      allow read, write: if isAdmin();
    }
    
    // ===========================================
    // SUGGESTION WORKFLOWS
    // ===========================================
    
    // Suggestion reviews - admin only
    match /suggestion-reviews/{reviewId} {
      allow read, write: if isAdmin();
    }
    
    // Bulk operations tracking - admin only
    match /bulk-operations/{operationId} {
      allow read, write: if isAdmin();
    }
    
    // ===========================================
    // ANALYTICS & REPORTS
    // ===========================================
    
    // Analytics data - admin read only
    match /analytics/{document} {
      allow read: if isAdmin();
      allow write: if false; // Generated by functions
    }
    
    // Usage reports - admin read only  
    match /usage-reports/{reportId} {
      allow read: if isAdmin();
      allow write: if false; // Generated by functions
    }
    
    // ===========================================
    // SYSTEM COLLECTIONS
    // ===========================================
    
    // System status - read by admins, write by functions
    match /system-status/{document} {
      allow read: if isAdmin();
      allow write: if false; // Only Cloud Functions
    }
    
    // Error logs - read by admins, write by functions
    match /error-logs/{errorId} {
      allow read: if isAdmin();
      allow write: if false; // Only Cloud Functions  
    }
    
    // Performance metrics - read by admins, write by functions
    match /performance-metrics/{metricId} {
      allow read: if isAdmin();
      allow write: if false; // Only Cloud Functions
    }
    
    // ===========================================
    // BACKUP & SYNC COLLECTIONS
    // ===========================================
    
    // Data export logs - admin only
    match /export-logs/{exportId} {
      allow read, write: if isAdmin();
    }
    
    // Sync status - admin read, functions write
    match /sync-status/{document} {
      allow read: if isAdmin();
      allow write: if false; // Only Cloud Functions
    }
    
    // ===========================================
    // DEFAULT FALLBACK
    // ===========================================
    
    // Default deny for any unlisted collections
    match /{document=**} {
      allow read, write: if false;
    }
  }
}