name: Community Data CD - Process and Upload

on:
  pull_request:
    paths:
      - 'data/sources/discord/**'
      - 'data/sources/reddit/**'
      - 'data/sources/wgu-connect/**'
      - 'data/sources/wgu-student-groups/**'
      - 'data/pipelines/discord/**'
      - 'data/pipelines/reddit/**'
      - '.github/workflows/community-data-cd.yml'
  push:
    branches: [ main ]
    paths:
      - 'data/sources/discord/**'
      - 'data/sources/reddit/**'
      - 'data/sources/wgu-connect/**'
      - 'data/sources/wgu-student-groups/**'
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write

jobs:
  process-community-data:
    name: Process Community Data
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Install DVC
        run: |
          pip install dvc[gdrive]

      - name: Configure DVC
        run: |
          dvc remote modify origin gdrive_use_service_account true
          dvc remote modify origin --local gdrive_service_account_json '${{ secrets.DVC_SERVICE_ACCOUNT }}'

      - name: Pull community data from DVC
        run: |
          dvc pull data/sources/discord/
          dvc pull data/sources/reddit/
          dvc pull data/sources/wgu-connect/
          dvc pull data/sources/wgu-student-groups/

      - name: Install dependencies
        working-directory: data
        run: npm ci

      - name: Validate Discord Data
        id: validate-discord
        working-directory: data
        run: |
          echo "🔍 Validating Discord data..."
          npm run validate:discord || echo "DISCORD_FAILED=true" >> $GITHUB_OUTPUT

      - name: Validate Reddit Data
        id: validate-reddit
        working-directory: data
        run: |
          echo "🔍 Validating Reddit data..."
          npm run validate:reddit || echo "REDDIT_FAILED=true" >> $GITHUB_OUTPUT

      - name: Check Discord Invites (PR only)
        if: github.event_name == 'pull_request'
        working-directory: data
        run: |
          echo "🔗 Checking Discord invite links..."
          npm run validate:discord:check-invites || true

      - name: Generate Validation Report
        if: github.event_name == 'pull_request'
        run: |
          echo "## 📊 Community Data Validation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Discord status
          if [ "${{ steps.validate-discord.outputs.DISCORD_FAILED }}" == "true" ]; then
            echo "- **Discord**: ❌ Failed validation" >> $GITHUB_STEP_SUMMARY
          else
            echo "- **Discord**: ✅ Passed validation" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Reddit status
          if [ "${{ steps.validate-reddit.outputs.REDDIT_FAILED }}" == "true" ]; then
            echo "- **Reddit**: ❌ Failed validation" >> $GITHUB_STEP_SUMMARY
          else
            echo "- **Reddit**: ✅ Passed validation" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Comment on PR with Results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const summary = fs.readFileSync(process.env.GITHUB_STEP_SUMMARY, 'utf8');
            
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## 🤖 Community Data Validation Results\n\n${summary}\n\n${
                summary.includes('❌') 
                  ? '⚠️ Some validations failed. Please fix the issues before merging.' 
                  : '✅ All validations passed. These changes will be uploaded to Firestore when merged.'
              }`
            });

  upload-community-data:
    name: Upload Community Data to Firestore
    needs: process-community-data
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Install DVC
        run: |
          pip install dvc[gdrive]

      - name: Configure DVC
        run: |
          dvc remote modify origin gdrive_use_service_account true
          dvc remote modify origin --local gdrive_service_account_json '${{ secrets.DVC_SERVICE_ACCOUNT }}'

      - name: Pull community data from DVC
        run: |
          dvc pull data/sources/

      - name: Install dependencies
        working-directory: data
        run: npm ci

      - name: Set up Firebase credentials
        env:
          FIREBASE_SERVICE_ACCOUNT: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}
        run: |
          echo "$FIREBASE_SERVICE_ACCOUNT" > serviceAccount.json

      - name: Process and Upload Discord Data
        env:
          GOOGLE_APPLICATION_CREDENTIALS: ${{ github.workspace }}/serviceAccount.json
        working-directory: data
        run: |
          echo "📤 Processing Discord communities..."
          npm run ingest:discord || echo "Discord ingestion not configured"

      - name: Process and Upload Reddit Data
        env:
          GOOGLE_APPLICATION_CREDENTIALS: ${{ github.workspace }}/serviceAccount.json
        working-directory: data
        run: |
          echo "📤 Processing Reddit communities..."
          npm run ingest:reddit || echo "Reddit ingestion not configured"

      - name: Process and Upload WGU Connect Data
        env:
          GOOGLE_APPLICATION_CREDENTIALS: ${{ github.workspace }}/serviceAccount.json
        working-directory: data
        run: |
          echo "📤 Processing WGU Connect groups..."
          npm run ingest:wgu-connect || echo "WGU Connect ingestion not configured"

      - name: Process and Upload Student Groups
        env:
          GOOGLE_APPLICATION_CREDENTIALS: ${{ github.workspace }}/serviceAccount.json
        working-directory: data
        run: |
          echo "📤 Processing WGU Student Groups..."
          npm run ingest:wgu-student-groups || echo "Student Groups ingestion not configured"

      - name: Clean up credentials
        if: always()
        run: rm -f serviceAccount.json

      - name: Create success notification
        run: |
          echo "## ✅ Community Data Upload Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Timestamp**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Data Sources Processed:" >> $GITHUB_STEP_SUMMARY
          echo "- Discord Communities" >> $GITHUB_STEP_SUMMARY
          echo "- Reddit Subreddits" >> $GITHUB_STEP_SUMMARY
          echo "- WGU Connect Groups" >> $GITHUB_STEP_SUMMARY
          echo "- WGU Student Groups" >> $GITHUB_STEP_SUMMARY