name: Community Data CD - Process and Upload

on:
  pull_request:
    paths:
      - 'data/sources/discord/**'
      - 'data/sources/reddit/**'
      - 'data/sources/wgu-connect/**'
      - 'data/sources/wgu-student-groups/**'
      - 'data/pipelines/discord/**'
      - 'data/pipelines/reddit/**'
      - '.github/workflows/community-data-cd.yml'
  push:
    branches: [ main ]
    paths:
      - 'data/sources/discord/**'
      - 'data/sources/reddit/**'
      - 'data/sources/wgu-connect/**'
      - 'data/sources/wgu-student-groups/**'
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write

jobs:
  process-community-data:
    name: Process Community Data
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.14.0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'pnpm'

      - name: Install DVC
        run: |
          pip install dvc[gdrive]

      - name: Configure DVC  
        run: |
          echo "â„¹ï¸ DVC configured to use existing remote settings"
          dvc remote list

      - name: Pull community data from DVC
        run: |
          if [ "$GITHUB_ACTIONS" = "true" ]; then
            echo "â„¹ï¸ Skipping DVC pulls in CI - using existing local data"
          else
            dvc pull data/sources/discord/ || echo "âš ï¸ Discord DVC pull failed"
            dvc pull data/sources/reddit/ || echo "âš ï¸ Reddit DVC pull failed"
            dvc pull data/sources/wgu-connect/ || echo "âš ï¸ WGU Connect DVC pull failed"
            dvc pull data/sources/wgu-student-groups/ || echo "âš ï¸ Student Groups DVC pull failed"
          fi

      - name: Install dependencies
        working-directory: data
        run: pnpm install --frozen-lockfile

      - name: Validate Discord Data
        id: validate-discord
        working-directory: data
        run: |
          echo "ðŸ” Validating Discord data..."
          pnpm run validate:discord || echo "DISCORD_FAILED=true" >> $GITHUB_OUTPUT

      - name: Validate Reddit Data
        id: validate-reddit
        working-directory: data
        run: |
          echo "ðŸ” Validating Reddit data..."
          pnpm run validate:reddit || echo "REDDIT_FAILED=true" >> $GITHUB_OUTPUT

      - name: Check Discord Invites (PR only)
        if: github.event_name == 'pull_request'
        working-directory: data
        run: |
          echo "ðŸ”— Checking Discord invite links..."
          pnpm run validate:discord:check-invites || true

      - name: Generate Validation Report
        if: github.event_name == 'pull_request'
        run: |
          echo "## ðŸ“Š Community Data Validation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Discord status
          if [ "${{ steps.validate-discord.outputs.DISCORD_FAILED }}" == "true" ]; then
            echo "- **Discord**: âŒ Failed validation" >> $GITHUB_STEP_SUMMARY
          else
            echo "- **Discord**: âœ… Passed validation" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Reddit status
          if [ "${{ steps.validate-reddit.outputs.REDDIT_FAILED }}" == "true" ]; then
            echo "- **Reddit**: âŒ Failed validation" >> $GITHUB_STEP_SUMMARY
          else
            echo "- **Reddit**: âœ… Passed validation" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Comment on PR with Results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const summary = fs.readFileSync(process.env.GITHUB_STEP_SUMMARY, 'utf8');
            
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## ðŸ¤– Community Data Validation Results\n\n${summary}\n\n${
                summary.includes('âŒ') 
                  ? 'âš ï¸ Some validations failed. Please fix the issues before merging.' 
                  : 'âœ… All validations passed. These changes will be uploaded to Firestore when merged.'
              }`
            });

  upload-community-data:
    name: Upload Community Data to Firestore
    needs: process-community-data
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.14.0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'pnpm'

      - name: Install DVC
        run: |
          pip install dvc[gdrive]

      - name: Configure DVC  
        run: |
          echo "â„¹ï¸ DVC configured to use existing remote settings"
          dvc remote list

      - name: Pull community data from DVC
        run: |
          if [ "$GITHUB_ACTIONS" = "true" ]; then
            echo "â„¹ï¸ Skipping DVC pulls in CI - using existing local data"
          else
            dvc pull data/sources/ || echo "âš ï¸ DVC pull failed - continuing with existing data"
          fi

      - name: Install dependencies
        working-directory: data
        run: pnpm install --frozen-lockfile

      - name: Set up Firebase credentials
        env:
          FIREBASE_SERVICE_ACCOUNT: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}
        run: |
          echo "$FIREBASE_SERVICE_ACCOUNT" > serviceAccount.json

      - name: Process and Upload Discord Data
        env:
          GOOGLE_APPLICATION_CREDENTIALS: ${{ github.workspace }}/serviceAccount.json
        working-directory: data
        run: |
          echo "ðŸ“¤ Processing Discord communities..."
          pnpm run ingest:discord || echo "Discord ingestion not configured"

      - name: Process and Upload Reddit Data
        env:
          GOOGLE_APPLICATION_CREDENTIALS: ${{ github.workspace }}/serviceAccount.json
        working-directory: data
        run: |
          echo "ðŸ“¤ Processing Reddit communities..."
          pnpm run ingest:reddit || echo "Reddit ingestion not configured"

      - name: Process and Upload WGU Connect Data
        env:
          GOOGLE_APPLICATION_CREDENTIALS: ${{ github.workspace }}/serviceAccount.json
        working-directory: data
        run: |
          echo "ðŸ“¤ Processing WGU Connect groups..."
          pnpm run ingest:wgu-connect || echo "WGU Connect ingestion not configured"

      - name: Process and Upload Student Groups
        env:
          GOOGLE_APPLICATION_CREDENTIALS: ${{ github.workspace }}/serviceAccount.json
        working-directory: data
        run: |
          echo "ðŸ“¤ Processing WGU Student Groups..."
          pnpm run ingest:wgu-student-groups || echo "Student Groups ingestion not configured"

      - name: Clean up credentials
        if: always()
        run: rm -f serviceAccount.json

      - name: Create success notification
        run: |
          echo "## âœ… Community Data Upload Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Timestamp**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Data Sources Processed:" >> $GITHUB_STEP_SUMMARY
          echo "- Discord Communities" >> $GITHUB_STEP_SUMMARY
          echo "- Reddit Subreddits" >> $GITHUB_STEP_SUMMARY
          echo "- WGU Connect Groups" >> $GITHUB_STEP_SUMMARY
          echo "- WGU Student Groups" >> $GITHUB_STEP_SUMMARY